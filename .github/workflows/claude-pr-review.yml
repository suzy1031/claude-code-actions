name: Claude Code PR review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: PR Review with Progress Tracking
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            レビュー内容はユーザーが読みやすい、以下のファーマットに沿ったマークダウン形式で出力すること。
            | label                         | value1                                  | value2                         | value3                        |
            | ----------------------------- | --------------------------------------- | ------------------------------ | ----------------------------- |
            | 日時 (レビューが完了した時刻) | yyyy-mm-dd hh:mm フォーマットで出力する | -                              | -                             |
            | コスト                        | $から円に換算して出力する               | -                              | -                             |
            | レビュー結果                  | LGTM!! or 修正お願いします              | -                              | -                             |
            | レビュー内容                  | レビュー内容を記入                      | ファイル名<br>e.g. src/calc.ts | 指摘箇所の行数<br>e.g. L10-12 |
          track_progress: true
          claude_args: |
            --model claude-3-5-haiku-20241022
